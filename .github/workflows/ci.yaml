name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'  # Specify your Go version

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run tests with race detector
        run: go test ./... -race -v
  integration-test:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Set up QEMU for multi-arch builds
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build REAL runner images
        run: |
          # Build amd64 runner
          docker buildx build -t multi-arch-runner:amd64 \
            --platform linux/amd64 \
            -f ./tests/Dockerfile.runner \
            --load .
          
          # Build arm64 runner (uses QEMU emulation)
          docker buildx build -t multi-arch-runner:arm64 \
            -f ./tests/Dockerfile.runner \
            --platform linux/arm64 \
            --load .  # use --push to push to a registry

      - name: Start server + test
        run: |
          # Start server
          go run ./cmd/server &
          SERVER_PID=$!
          
          # Wait for ready
          timeout 30s bash -c 'while ! curl -sSf http://localhost:8080/healthz; do sleep 1; done'
          
          # Submit real test job (uses your built images!)
          JOB_ID=$(curl -s -X POST http://localhost:8080/jobs \
            -H "Content-Type: application/json" \
            -d '{
              "repo": "https://github.com/golang/example.git",
              "commit": "HEAD",
              "test_command": "go test ./... || echo \"tests failed\"",
              "architectures": ["amd64"],
              "timeout": "60s"
            }' | jq -r '.id')
          
          echo "Job ID: $JOB_ID"
          
          # Wait for completion (poll /jobs/{id})
          for i in {1..60}; do
            STATUS=$(curl -s http://localhost:8080/jobs/$JOB_ID | jq -r '.status')
            echo "Job status: $STATUS (attempt $i/60)"
            if [[ "$STATUS" != "pending" && "$STATUS" != "running" ]]; then
              break
            fi
            sleep 5
          done
          
          # Assert final status
          FINAL_STATUS=$(curl -s http://localhost:8080/jobs/$JOB_ID | jq -r '.status')
          if [[ "$FINAL_STATUS" == "passed" ]]; then
            echo "Integration test PASSED"
          else
            echo "Integration test FAILED: $FINAL_STATUS"
            exit 1
          fi
